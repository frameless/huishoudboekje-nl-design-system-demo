version: "3"
services:
  # Database preparations
  db-init:
    image: postgres:13-alpine
    command:
      - /bin/sh
      - -c
      - >-
        export PGPASSWORD=postgres &&
        psql -h host.docker.internal -U postgres -c "CREATE USER hhb WITH PASSWORD 'hhb'" || true &&
        psql -h host.docker.internal -U postgres -c "CREATE DATABASE huishoudboekjeservice" || true &&
        psql -h host.docker.internal -U postgres -c "CREATE DATABASE organisatieservice" || true &&
        psql -h host.docker.internal -U postgres -c "CREATE DATABASE banktransactieservice" || true &&
        psql -h host.docker.internal -U postgres -c "CREATE DATABASE grootboekservice" || true &&
        psql -h host.docker.internal -U postgres -c "CREATE DATABASE logservice" || true

#  # Frontend # Todo: super slow, doesn't work yet.
#  frontend:
#    build:
#      dockerfile: ./frontend/dev.Dockerfile
#      context: .
#    environment:
#      PROXY: http://localhost:5000
#    volumes:
#      - ./frontend:/app
#    ports:
#      - 3000:3000
#    command:
#      - npm install && npm start

  backend:
    build:
      dockerfile: ./backend/dev.Dockerfile
      context: .
    volumes:
      - ./backend:/app
    environment:
      APP_SETTINGS: hhb_backend.config.LocalConfig
      HHB_SECRET: koen
#     AUTH_AUDIENCE: None
#     AUTH_TOKEN_SECRET: koen
      OIDC_CLIENT_SECRETS: /app/etc/client_secrets.json
#     OIDC_CLOCK_SKEW: "600"
      PREFIX: "/api"
      HHB_SERVICE_URL: "http://huishoudboekjeservice:8000"
      ORGANISATIE_SERVICE_URL: "http://organisatieservice:8000"
      TRANSACTIE_SERVICE_URL: "http://banktransactieservice:8000"
      GROOTBOEK_SERVICE_URL: "http://grootboekservice:8000"
      LOG_SERVICE_URL: "http://logservice:8000"
      SECRET_KEY: koen
    ports:
      - 5000:8000

  huishoudboekjeservice:
    build:
      dockerfile: ./services/huishoudboekje_service/dev.Dockerfile
      context: .
    volumes:
      - ./services/huishoudboekje_service:/app
      - ./services/core_service/core_service:/app/core_service
    environment:
      HHB_DATABASE_URL: "postgresql://hhb:hhb@host.docker.internal/huishoudboekjeservice"
    ports:
      - 8001:8000

  organisatieservice:
    build:
      dockerfile: ./services/organisatie_service/dev.Dockerfile
      context: .
    volumes:
      - ./services/organisatie_service:/app
      - ./services/core_service/core_service:/app/core_service
    environment:
      ORGANISATIE_DATABASE_URL: "postgresql://hhb:hhb@host.docker.internal/organisatieservice"
    ports:
      - 8002:8000

  banktransactieservice:
    build:
      dockerfile: ./services/bank_transactie_service/dev.Dockerfile
      context: .
    volumes:
      - ./services/bank_transactie_service:/app
      - ./services/core_service/core_service:/app/core_service
    environment:
      ORGANISATIE_DATABASE_URL: "postgresql://hhb:hhb@host.docker.internal/banktransactieservice"
    ports:
      - 8003:8000

  grootboekservice:
    build:
      dockerfile: ./services/grootboek_service/dev.Dockerfile
      context: .
    volumes:
      - ./services/grootboek_service:/app
      - ./services/core_service/core_service:/app/core_service
    environment:
      ORGANISATIE_DATABASE_URL: "postgresql://hhb:hhb@host.docker.internal/grootboekservice"
    ports:
      - 8004:8000

  logservice:
    build:
      dockerfile: ./services/log_service/dev.Dockerfile
      context: .
    volumes:
      - ./services/log_service:/app
      - ./services/core_service/core_service:/app/core_service
    environment:
      ORGANISATIE_DATABASE_URL: "postgresql://hhb:hhb@host.docker.internal/logservice"
    ports:
      - 8005:8000