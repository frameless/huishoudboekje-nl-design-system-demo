clean-namespaces:
  stage: maintenance
  environment:
    name: review/$CI_COMMIT_REF_SLUG
  variables:
    GIT_STRATEGY: none
  image: registry.gitlab.com/commonground/core/review-app-deployer:latest
  script:
    - echo "Cleaning up old namespaces..."
    - kubectl get namespaces --sort-by=.metadata.creationTimestamp | awk '$1 !~ /hhb-/ {next} $1 !~ /hhb-(acc|demo|test|nijmegen|utrecht)/ {system("kubectl delete namespace " $1)}'
  when: manual
  needs: []
  tags:
    - cg
    - docker

env:
  stage: maintenance
  needs: []
  when: manual
  script:
    - env -0 | sort -z | tr '\0' '\n'
