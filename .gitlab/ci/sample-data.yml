.sample-data:
  stage: sample-data
  extends:
    - .maintenance
  when: manual
  before_script:
    - helm delete sample-data-${JOB_TYPE} --namespace $REVIEW_NAMESPACE || true
  script:
    - |
      helm upgrade --install \
        sample-data-${JOB_TYPE} helm/repo/sample-data-${COMPONENT_VERSION}.tgz \
        --namespace $REVIEW_NAMESPACE \
        --set "global.imageTag=$IMAGE_TAG" \
        --set jobType=${JOB_TYPE} \
        ${HELM_DEBUG:+--debug}
    - |
      sleep 3
      kubectl wait job \
        --namespace $REVIEW_NAMESPACE \
        --selector=app.kubernetes.io/instance=sample-data-${JOB_TYPE} \
        --for=condition=Complete \
        --timeout=60s
  after_script:
    - |
      kubectl logs \
        --namespace $REVIEW_NAMESPACE \
        --selector=app.kubernetes.io/instance=sample-data-${JOB_TYPE} \
        --prefix \
        --tail=-1 \
        --timestamps

.sample-data-clean:
  variables:
    JOB_TYPE: "clean"
  extends:
    - .sample-data

.sample-data-load:
  variables:
    JOB_TYPE: "load"
  extends:
    - .sample-data

clean-review:
  extends:
    - .sample-data-clean
  needs:
    - build-helm
    - helm-test-review
  only:
    - branches@commonground/huishoudboekje/app-new
  except:
    - master
    - develop
    - acceptance

clean-develop:
  extends:
    - .sample-data-clean
  needs:
    - build-helm
    - helm-test-develop
  only:
    - develop@commonground/huishoudboekje/app-new

clean-acceptance:
  extends:
    - .sample-data-clean
  needs:
    - build-helm
    - deploy-acceptance
  only:
    - acceptance@commonground/huishoudboekje/app-new

clean-master:
  extends:
    - .sample-data-clean
  needs:
    - build-helm
    - deploy-master
  only:
    - master@commonground/huishoudboekje/app-new


load-review:
  extends:
    - .sample-data-load
  needs:
    - build-helm
    - helm-test-review
  only:
    - branches@commonground/huishoudboekje/app-new
  except:
    - master
    - develop
    - acceptance

load-develop:
  extends:
    - .sample-data-load
  needs:
    - build-helm
    - helm-test-develop
  only:
    - develop@commonground/huishoudboekje/app-new

load-acceptance:
  extends:
    - .sample-data-load
  needs:
    - build-helm
    - deploy-acceptance
  only:
    - acceptance@commonground/huishoudboekje/app-new

load-master:
  extends:
    - .sample-data-load
  needs:
    - build-helm
    - deploy-master
  only:
    - master@commonground/huishoudboekje/app-new
