.retry: &retry
  retry:
    max: 2
    when: script_failure

.deployer: &deployer
  image: registry.gitlab.com/commonground/huishoudboekje/review-app-deployer:latest

.authorize-azure-ad: &authorize-azure-ad
  stage: deploy
  image: mcr.microsoft.com/azure-cli:2.36.0

deploy-deployment-test:
  <<: *deployer
  <<: *retry
  stage: deploy
  needs:
    - build-images-dev
  environment:
    name: test
    url: https://test.hhb-development.nl/
  variables:
    APP_HOST: "test.hhb-development.nl"
    NAMESPACE: "hhb-test"
    UNLEASH_OTAP: test
    OIDC_BASE_URL: "https://test.hhb-development.nl"
    JWT_SECRET: $OIDC_CLIENT_SECRET
    JWT_ALGORITHMS: HS256,RS256
  script:
    - sh ./k8s/overlay/hhb-development-cluster/apply-env-vars.sh
    - kubectl config use-context commonground/huishoudboekje/app-new:hhb-development
    - kubectl create ns $NAMESPACE || true
    - kubectl kustomize ./k8s/overlay/hhb-development-cluster/test
    - kubectl apply -k ./k8s/overlay/hhb-development-cluster/test --namespace=$NAMESPACE
  rules:
    - if: $CI_COMMIT_BRANCH == "develop"

deploy-deployment-review:
  <<: *deployer
  <<: *retry
  needs:
    - build-images-dev
  stage: deploy
  environment:
    name: review/$CI_COMMIT_REF_SLUG
    url: https://hhb-$CI_COMMIT_REF_SLUG.review.hhb-development.nl/
    on_stop: destroy-review
    auto_stop_in: 7 days
  variables:
    APP_HOST: "hhb-$CI_COMMIT_REF_SLUG.review.hhb-development.nl"
    NAMESPACE: "hhb-$CI_COMMIT_REF_SLUG"
    UNLEASH_OTAP: development
    OIDC_BASE_URL: "https://hhb-$CI_COMMIT_REF_SLUG.review.hhb-development.nl"
    JWT_SECRET: $OIDC_CLIENT_SECRET
    JWT_ALGORITHMS: HS256,RS256
  script:  
    - sh ./k8s/overlay/hhb-development-cluster/apply-env-vars.sh
    - kubectl config use-context commonground/huishoudboekje/app-new:hhb-development
    - kubectl create ns $NAMESPACE || true
    - kubectl kustomize ./k8s/overlay/hhb-development-cluster/review
    - kubectl apply -k ./k8s/overlay/hhb-development-cluster/review --namespace=$NAMESPACE  
  rules:
    - if: $CI_PIPELINE_SOURCE == 'merge_request_event'

authorize-azure-ad-review:
  <<: *authorize-azure-ad
  environment:
    name: review/$CI_COMMIT_REF_SLUG
    on_stop: unauthorize-azure-ad-review
  variables:
    GIT_STRATEGY: none # the runner won’t try to check out the code after the branch is deleted.
    APP_HOST: "hhb-$CI_COMMIT_REF_SLUG.review.hhb-development.nl"
  script:
    - az login --service-principal -u $AZURE_CLIENT_ID -p $AZURE_CLIENT_SECRET --tenant $AZURE_TENANT_ID
    - az ad app update --id $OIDC_CLIENT_ID --add replyUrls "https://${APP_HOST}/auth/callback" || true
  rules:
    - if: $CI_PIPELINE_SOURCE == 'merge_request_event'

unauthorize-azure-ad-review:
  <<: *authorize-azure-ad
  environment:
    name: review/$CI_COMMIT_REF_SLUG
    action: stop
  variables:
    GIT_STRATEGY: none # the runner won’t try to check out the code after the branch is deleted.
    APP_HOST: "hhb-$CI_COMMIT_REF_SLUG.review.hhb-development.nl"
  script:
    - az login --service-principal -u $AZURE_CLIENT_ID -p $AZURE_CLIENT_SECRET --tenant $AZURE_TENANT_ID
    # find the index of the url that needs to be removed
    - az ad app show --id $OIDC_CLIENT_ID --query "web.redirectUris"
    - export redirect_urls=$(az ad app show --id $OIDC_CLIENT_ID --query "web.redirectUris")
    - export index=$(echo $redirect_urls | jq -r ". | index(\"https://${APP_HOST}/auth/callback\")")
    - echo "$redirect_urls"
    - echo "$index"
    - echo "test"
    - if [ "$index" == "null" ]; then echo "URL not found"; exit 2; fi
    # use the index to remove the url from azure ad
    #- az ad app update --id $OIDC_CLIENT_ID --remove replyUrls $index
    - unset index
    - unset redirect_urls
  when: manual
  rules:
    - if: $CI_PIPELINE_SOURCE == 'merge_request_event'

## Destroy app (only review cluster)
destroy-review:
  <<: *deployer
  stage: deploy
  needs:
    - deploy-deployment-review
  environment:
    name: review/$CI_COMMIT_REF_SLUG
    action: stop
  variables:
    GIT_STRATEGY: none # the runner won’t try to check out the code after the branch is deleted.
    NAMESPACE: "hhb-$CI_COMMIT_REF_SLUG"
    APP_HOST: "hhb-$CI_COMMIT_REF_SLUG.review.hhb-development.nl"
  before_script:
    - kubectl config use-context commonground/huishoudboekje/app-new:hhb-development
  script:
    - kubectl delete namespace ${NAMESPACE}
  when: manual
  rules:
    - if: $CI_PIPELINE_SOURCE == 'merge_request_event'
