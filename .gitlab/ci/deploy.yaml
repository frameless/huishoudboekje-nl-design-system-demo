.retry: &retry
  retry:
    max: 2
    when: script_failure

.deployer: &deployer
  image: registry.gitlab.com/commonground/huishoudboekje/review-app-deployer:latest
  tags:
    - cg
    - docker

.authorize-keycloak: &authorize-keycloak
  stage: deploy
  image: registry.gitlab.com/commonground/huishoudboekje/keycloak-tools/keycloak-tools:1.0.0
  before_script:
    - cd /app
  tags:
    - cg
    - docker

#
# demo.huishoudboekje is (currently) not used
#
# deploy-deployment-master:
#   <<: *deploy
#   needs:
#     - build-images-dev
#   environment:
#     name: demo
#     url: https://demo.huishoudboekje.demoground.nl/
#   variables:
#     APP_HOST: "demo.huishoudboekje.demoground.nl"
#     NAMESPACE: "hhb-demo"
#     USE_LETSENCRYPT: 1
#     UNLEASH_OTAP: production
#     OIDC_BASE_URL: "https://demo.huishoudboekje.demoground.nl"
#     OIDC_ISSUER_URL: https://keycloak.huishoudboekje.demoground.nl/realms/huishoudboekje/
#     OIDC_CLIENT_ID: huishoudboekje-medewerkers
#     JWT_ISSUER: demo.huishoudboekje.demoground.nl
#     JWT_AUDIENCE: demo.huishoudboekje.demoground.nl
#     JWT_SECRET: demodemo
#   before_script:
#     - kubectl config use-context commonground/huishoudboekje/app-new:hhb-prod
#   only:
#     - master

#
# acc.huishoudboekje is (currently) not used
#
# deploy-deployment-acceptance:
#   <<: *deploy
#   needs:
#     - build-images-dev
#   environment:
#     name: acc
#     url: https://acc.huishoudboekje.demoground.nl/
#   variables:
#     APP_HOST: "acc.huishoudboekje.demoground.nl"
#     NAMESPACE: "hhb-acc"
#     USE_LETSENCRYPT: 1
#     UNLEASH_OTAP: acceptance
#     OIDC_BASE_URL: "https://acc.huishoudboekje.demoground.nl"
#     OIDC_ISSUER_URL: https://keycloak.huishoudboekje.demoground.nl/realms/huishoudboekje/
#     OIDC_CLIENT_ID: huishoudboekje-medewerkers
#     JWT_ISSUER: acc.huishoudboekje.demoground.nl
#     JWT_AUDIENCE: acc.huishoudboekje.demoground.nl
#     JWT_SECRET: accaccacc
#   before_script:
#     - kubectl config use-context commonground/huishoudboekje/app-new:hhb-prod
#   only:
#     - acceptance

deploy-deployment-test:
  <<: *deployer
  <<: *retry
  stage: deploy
  needs:
    - build-images-dev
  environment:
    name: test
    url: https://test.huishoudboekje.demoground.nl/
  variables:
    APP_HOST: "test.huishoudboekje.demoground.nl"
    NAMESPACE: "hhb-test"
    UNLEASH_OTAP: test
    OIDC_BASE_URL: "https://test.huishoudboekje.demoground.nl"
    OIDC_ISSUER_URL: https://keycloak.huishoudboekje.demoground.nl/realms/huishoudboekje/
    OIDC_CLIENT_ID: huishoudboekje-medewerkers
    JWT_ISSUER: https://keycloak.huishoudboekje.demoground.nl/realms/huishoudboekje
    JWT_AUDIENCE: account
    JWT_SECRET: $OIDC_CLIENT_SECRET
    JWT_ALGORITHMS: HS256,RS256
    REDIS_PASSWORD: $REDIS_PASSWORD
    REDIS_AUTH_PASSWORD: $REDIS_AUTH_PASSWORD
  script:
    - sh ./k8s/overlay/hhb-cluster/apply-env-vars.sh
    - kubectl config use-context commonground/huishoudboekje/app-new:hhb-prod
    - kubectl kustomize ./k8s/overlay/hhb-cluster/prod/test
    - kubectl apply -k ./k8s/overlay/hhb-cluster/prod/test --namespace=$NAMESPACE
  only:
    - develop

# Deploy for review cluster
deploy-deployment-review:
  <<: *deployer
  <<: *retry
  needs:
    - build-images-dev
  stage: deploy
  environment:
    name: review/$CI_COMMIT_REF_SLUG
    url: https://hhb-$CI_COMMIT_REF_SLUG.nlx.reviews/
    on_stop: destroy-review
    auto_stop_in: 7 days
  variables:
    APP_HOST: "hhb-$CI_COMMIT_REF_SLUG.nlx.reviews"
    NAMESPACE: "hhb-$CI_COMMIT_REF_SLUG"
    UNLEASH_OTAP: development
    OIDC_BASE_URL: "https://hhb-$CI_COMMIT_REF_SLUG.nlx.reviews"
    OIDC_ISSUER_URL: https://keycloak.huishoudboekje.demoground.nl/realms/huishoudboekje/
    OIDC_CLIENT_ID: huishoudboekje-medewerkers
    JWT_ISSUER: https://keycloak.huishoudboekje.demoground.nl/realms/huishoudboekje
    JWT_AUDIENCE: account
    JWT_SECRET: $OIDC_CLIENT_SECRET
    JWT_ALGORITHMS: HS256,RS256
    REDIS_PASSWORD: $REDIS_PASSWORD
    REDIS_AUTH_PASSWORD: $REDIS_AUTH_PASSWORD
  script:
    - sh ./k8s/overlay/hhb-cluster/apply-env-vars.sh
    - kubectl config use-context commonground/huishoudboekje/app-new:hhb-review
    - kubectl create ns $NAMESPACE || true
    - kubectl kustomize ./k8s/overlay/hhb-cluster/review
    - kubectl apply -k ./k8s/overlay/hhb-cluster/review --namespace=$NAMESPACE
  only:
    - branches@commonground/huishoudboekje/app-new
  except:
    - master
    - develop
    - acceptance

authorize-keycloak-review:
  <<: *authorize-keycloak
  environment:
    name: review/$CI_COMMIT_REF_SLUG
    on_stop: unauthorize-keycloak-review
  variables:
    GIT_STRATEGY: none # the runner won’t try to check out the code after the branch is deleted.
    KEYCLOAK_REALM_NAME: huishoudboekje
    KEYCLOAK_BASE_URL: https://keycloak.huishoudboekje.demoground.nl
    APP_HOST: "hhb-$CI_COMMIT_REF_SLUG.nlx.reviews"
  script:
    - echo "Adding application to Keycloak..."
    - npm run start -- redirect-uri add --uri="https://${APP_HOST}/auth/callback" --client-id=huishoudboekje-medewerkers
  only:
    - branches@commonground/huishoudboekje/app-new
  except:
    - master
    - develop
    - acceptance

unauthorize-keycloak-review:
  <<: *authorize-keycloak
  environment:
    name: review/$CI_COMMIT_REF_SLUG
    action: stop
  variables:
    GIT_STRATEGY: none # the runner won’t try to check out the code after the branch is deleted.
    KEYCLOAK_REALM_NAME: huishoudboekje
    KEYCLOAK_BASE_URL: https://keycloak.huishoudboekje.demoground.nl
    APP_HOST: "hhb-$CI_COMMIT_REF_SLUG.nlx.reviews"
  script:
    - echo "Removing application from Keycloak..."
    - npm run start -- redirect-uri remove --uri="https://${APP_HOST}/auth/callback" --client-id=huishoudboekje-medewerkers
  when: manual
  only:
    - branches@commonground/huishoudboekje/app-new
  except:
    - master
    - develop
    - acceptance

## Destroy app (only review cluster)
destroy-review:
  <<: *deployer
  stage: deploy
  needs:
    - deploy-deployment-review
  environment:
    name: review/$CI_COMMIT_REF_SLUG
    action: stop
  variables:
    GIT_STRATEGY: none # the runner won’t try to check out the code after the branch is deleted.
    NAMESPACE: "hhb-$CI_COMMIT_REF_SLUG"
    APP_HOST: "hhb-$CI_COMMIT_REF_SLUG.nlx.reviews"
  before_script:
    - kubectl config use-context commonground/huishoudboekje/app-new:hhb-review
  script:
    - kubectl delete namespace ${NAMESPACE}
  when: manual
  only:
    - branches@commonground/huishoudboekje/app-new
  except:
    - master
    - develop
    - acceptance
