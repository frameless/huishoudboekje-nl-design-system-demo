.load-sample-data: &load-sample-data
  stage: data
  image: registry.gitlab.com/commonground/huishoudboekje/data-importer/data-importer:1.5.1
  variables:
    CYPRESS_INSTALL_BINARY: "0"
    APP_HOST: hhb-$CI_COMMIT_REF_SLUG.nlx.reviews
  tags:
    - cg
    - docker
  when: manual
  before_script:
    - set -e
    - export GRAPHQL_API_URL=https://${APP_HOST}/api/graphql
    - export DATA_PATH=/builds/$CI_PROJECT_PATH/sampleData/import.json
    - cd /app
    - echo "Generating API key..."
    - |
      export AUTH_TOKEN=`npx --yes --quiet --package '@clarketm/jwt-cli' \
        jwt sign \
        --expiresIn "1 hour" \
        --subject "sampledata@${APP_HOST}" \
        --issuer "${APP_HOST}" \
        --audience "${APP_HOST}" \
        --jwtid "$(LC_CTYPE=C tr -dc 'A-F0-9' < /dev/urandom | head -c32)" \
        --noCopy \
        "{ \"name\": \"sampledata\", \"email\": \"sampledata@${APP_HOST}\" }" "${JWT_SECRET:-$SESSION_SECRET}"`
    - echo "Preparations finished."
  script:
    - importer import

load-data-review:
  <<: *load-sample-data
  environment:
    name: review/$CI_COMMIT_REF_SLUG
  variables:
    APP_HOST: "hhb-$CI_COMMIT_REF_SLUG.nlx.reviews"
    JWT_SECRET: koen-hhb-$CI_COMMIT_REF_SLUG
  needs:
    - deploy-deployment-review
  only:
    - branches@commonground/huishoudboekje/app-new
  except:
    - master
    - develop
    - acceptance

load-data-develop:
  <<: *load-sample-data
  environment:
    name: test
  variables:
    APP_HOST: "test.huishoudboekje.demoground.nl"
    JWT_SECRET: testtest
  needs:
    - deploy-deployment-test
  only:
    - develop
