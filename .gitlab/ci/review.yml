# Set up review app (Frontend)
deploy-review-frontend:
  stage: deploy
  image: registry.gitlab.com/commonground/core/review-app-deployer:latest
  variables:
    KUBECONFIG: /secrets/kubeconfig/review.conf
  script:
    - |
      helm upgrade --install --create-namespace $REVIEW_NAMESPACE ./frontend/helm \
      --namespace $REVIEW_NAMESPACE \
      --set "ingress.enabled=true" \
      --set "ingress.hosts[0].host=hhb-$CI_ENVIRONMENT_SLUG.$REVIEW_BASE_DOMAIN" \
      --set "ingress.hosts[0].paths[0]=/" \
      --set "image.tag=$IMAGE_TAG"
  environment:
    name: $CI_COMMIT_REF_NAME
    url: https://hhb-$CI_ENVIRONMENT_SLUG.$REVIEW_BASE_DOMAIN/
    on_stop: destroy-review-frontend
  only:
    - branches@commonground/huishoudboekje/app-new
  tags:
    - cg
    - docker

# Shut down review app (Frontend)
destroy-review-frontend:
  stage: deploy
  image: registry.gitlab.com/commonground/core/review-app-deployer:latest
  variables:
    GIT_STRATEGY: none
    KUBECONFIG: /secrets/kubeconfig/review.conf
  script:
    - helm uninstall $REVIEW_NAMESPACE --namespace $REVIEW_NAMESPACE
    - kubectl delete namespace $REVIEW_NAMESPACE
  when: manual
  environment:
    name: $CI_COMMIT_REF_NAME
    url: https://hhb-$CI_ENVIRONMENT_SLUG.$REVIEW_BASE_DOMAIN
    action: stop
  only:
    - branches@commonground/huishoudboekje/app-new
  tags:
    - cg
    - docker
