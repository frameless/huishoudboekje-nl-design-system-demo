load-sample-data:
  stage: data
  environment:
    name: review/$CI_COMMIT_REF_SLUG
  image:
    name: ${DOCKER_PROXY}node:lts-alpine
  variables:
    NPM_CACHE_DIR: "${CI_PROJECT_DIR}/.cache/npm"
    CYPRESS_INSTALL_BINARY: "0"
  tags:
    - cg
    - docker
  when: manual
  needs:
    - job: deploy-review
      artifacts: true
    - job: cypress-token-review
      artifacts: true
  before_script:
    - cat $CI_PROJECT_DIR/ci_cypress_token.txt
    - echo "Generating new API key..."
    - |
      npx --yes --quiet --package '@clarketm/jwt-cli' \
      jwt sign \
      --expiresIn "1 hour" \
      --subject "cypress@huishoudboekje.nlx.reviews" \
      --issuer "https://huishoudboekje.nlx.reviews" \
      --audience "https://huishoudboekje.nlx.reviews" \
      --jwtid "$(LC_CTYPE=C tr -dc 'A-F0-9' < /dev/urandom | head -c32)" \
      --noCopy \
      "{}" "${SESSION_SECRET:-test}" > $CI_PROJECT_DIR/ci_cypress_token.txt
    - cat $CI_PROJECT_DIR/ci_cypress_token.txt
  script:
    - export GRAPHQL_API_URL="https://`cat $CI_PROJECT_DIR/ci_review_hostname.txt`/api/graphql"
    - export PROXY_AUTHORIZATION=`cat $CI_PROJECT_DIR/ci_cypress_token.txt`
    - echo $GRAPHQL_API_URL
    - echo $PROXY_AUTHORIZATION
    - cd ./sampleData
    - npm ci
    - npm start