.load-sample-data: &load-sample-data
  stage: data
  image:
    name: ${DOCKER_PROXY}node:lts-alpine
  variables:
    NPM_CACHE_DIR: "${CI_PROJECT_DIR}/.cache/npm"
    CYPRESS_INSTALL_BINARY: "0"
  tags:
    - cg
    - docker
  when: manual
  script:
    - echo "Generating API key..."
    - |
      export PROXY_AUTHORIZATION=`npx --yes --quiet --package '@clarketm/jwt-cli' \
        jwt sign \
        --expiresIn "1 week" \
        --subject "cypress@huishoudboekje.nlx.reviews" \
        --issuer "https://huishoudboekje.nlx.reviews" \
        --audience "https://huishoudboekje.nlx.reviews" \
        --jwtid "$(LC_CTYPE=C tr -dc 'A-F0-9' < /dev/urandom | head -c32)" \
        --noCopy \
        "{}" "${SESSION_SECRET:-test}"`
    - echo JWT $PROXY_AUTHORIZATION
    - echo API_URL $GRAPHQL_API_URL
    - cd ./sampleData
    - npm ci
    - npm start

load-data-review:
  <<: *load-sample-data
  environment:
    name: review/$CI_COMMIT_REF_SLUG
  variables:
    GRAPHQL_API_URL: https://hhb-$CI_COMMIT_REF_SLUG.nlx.reviews/api/graphql
  needs:
    - deploy-review
  only:
    - branches@commonground/huishoudboekje/app-new
  except:
    - master
    - develop
    - acceptance

load-data-develop:
  <<: *load-sample-data
  environment:
    name: test
  variables:
    GRAPHQL_API_URL: https://test.huishoudboekje.demoground.nl/api/graphql
  needs:
    - deploy-develop
  only:
    - develop
