.node:
  stage: test
  image: node:lts-alpine
  variables:
    NPM_CACHE_DIR: "${CI_PROJECT_DIR}/.cache/npm"
  needs: []
  cache:
    key: "${CI_COMMIT_REF_SLUG}__${CI_JOB_NAME}"
    paths:
      - ${NPM_CACHE_DIR}
  before_script:
    - cd ./frontend/app
    - npm ci --cache ${NPM_CACHE_DIR} --prefer-offline --no-progress --color=false --quiet
  tags:
    - cg
    - docker


frontend-lint:
  extends: .node
  script:
    - npm run lint


# This template requires the following:
#   variables:
#      DIRECTORY: <the directory of the application>
.Service Test:
  stage: test
  needs:
    - build
  tags:
    - cg
    - docker
  image:
    name: $CI_REGISTRY_IMAGE/$PYTHON_POSTGRES:$IMAGE_TAG
  variables:
    PIP_CACHE_DIR: "$CI_PROJECT_DIR/.cache/pip"
  cache:
    key: "${CI_COMMIT_REF_SLUG}__${CI_JOB_NAME}"
    paths:
      - ${PIP_CACHE_DIR}
  script:
    - make -C ${DIRECTORY} requirements
    - make -C ${DIRECTORY} all
  coverage: '/TOTAL.+ ([0-9]{1,3}%)/'
  artifacts:
    expire_in: 1 week
    when: always
    paths:
      - ${DIRECTORY}/htmlcov
    reports:
      cobertura: ${DIRECTORY}/coverage.xml
      junit: ${DIRECTORY}/report.xml

backend-test:
  extends: .Service Test
  variables:
    DIRECTORY: backend
  only:
    - branches@commonground/huishoudboekje/app-new

huishoudboekje-service-test:
  extends: .Service Test
  variables:
    DIRECTORY: services/huishoudboekje_service
  only:
    - branches@commonground/huishoudboekje/app-new

organisatie-service-test:
  extends: .Service Test
  variables:
    DIRECTORY: services/organisatie_service
  only:
    - branches@commonground/huishoudboekje/app-new

bank-transactie-service-test:
  extends: .Service Test
  variables:
    DIRECTORY: services/bank_transactie_service
  only:
    - branches@commonground/huishoudboekje/app-new

grootboek-service-test:
  extends: .Service Test
  variables:
    DIRECTORY: services/grootboek_service
  only:
    - branches@commonground/huishoudboekje/app-new
