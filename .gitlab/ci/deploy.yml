# Deploy template for app
.deploy-app:
  stage: deploy
  image: registry.gitlab.com/commonground/core/review-app-deployer:latest
  variables:
    KUBECONFIG: /secrets/kubeconfig/review.conf
  environment:
    name: $CI_COMMIT_REF_NAME
    url: https://$REVIEW_NAMESPACE.$REVIEW_BASE_DOMAIN/
    on_stop: destroy
  script:
    - |
      helm repo add stable "https://kubernetes-charts.storage.googleapis.com"
      helm repo update
    - |
      helm dependency build ./helm/charts/huishoudboekje
      (cd helm/charts/medewerker-frontend; ln -s ../../../frontend/theme/sloothuizen theme)
      helm upgrade --install --create-namespace \
        --namespace $REVIEW_NAMESPACE \
        $REVIEW_NAMESPACE \
        ./helm/charts/huishoudboekje --values ./helm/charts/huishoudboekje/values-review.yaml
        --set "medewerker-frontend.ingress.hosts[0].host=$REVIEW_NAMESPACE.$REVIEW_BASE_DOMAIN" \
        --set "medewerker-frontend.image.tag=$IMAGE_TAG" \
        --set "medewerker-backend.ingress.hosts[0].host=$REVIEW_NAMESPACE.$REVIEW_BASE_DOMAIN" \
        --set "medewerker-backend.oidc.issuer=https://dex-$REVIEW_NAMESPACE.$REVIEW_BASE_DOMAIN" \
        --set "medewerker-backend.oidc.clientSecret=ZwwcL2zjQyJUBnFPVoOb" \
        --set "medewerker-backend.oidc.authorizationEndpoint=https://dex-$REVIEW_NAMESPACE.$REVIEW_BASE_DOMAIN/auth" \
        --set "medewerker-backend.oidc.redirectUri=https://$REVIEW_NAMESPACE.$REVIEW_BASE_DOMAIN/api/oidc_callback" \
        --set "medewerker-backend.oidc.tokenUri=https://dex-$REVIEW_NAMESPACE.$REVIEW_BASE_DOMAIN/token" \
        --set "medewerker-backend.oidc.tokeninfoUri=https://dex-$REVIEW_NAMESPACE.$REVIEW_BASE_DOMAIN/tokeninfo" \
        --set "medewerker-backend.oidc.userinfoUri=https://dex-$REVIEW_NAMESPACE.$REVIEW_BASE_DOMAIN/userinfo" \
        --set "medewerker-backend.image.tag=$IMAGE_TAG" \
        --set "dex.ingress.hosts[0]=dex-$REVIEW_NAMESPACE.$REVIEW_BASE_DOMAIN" \
        --set "dex.config.issuer=https://dex-$REVIEW_NAMESPACE.$REVIEW_BASE_DOMAIN" \
        --set "dex.config.staticClients[0].redirectURIs[0]=https://$REVIEW_NAMESPACE.$REVIEW_BASE_DOMAIN/api/oidc_callback" \
        $([[ "$REVIEW_NAMESPACE" == "hhb-test" ]] && echo '--set "dex.config.staticClients[0].redirectURIs[1]=https://localhost:3000/api/oidc_callback"')
  only:
    - branches@commonground/huishoudboekje/app-new
  tags:
    - cg
    - docker

# Deploy (Review)
deploy-review:
  variables:
    KUBECONFIG: /secrets/kubeconfig/review.conf
    REVIEW_NAMESPACE: "hhb-${CI_ENVIRONMENT_SLUG}"
  extends: .deploy-app
  environment:
    name: $CI_COMMIT_REF_NAME
    url: https://hhb-${CI_ENVIRONMENT_SLUG}.${REVIEW_BASE_DOMAIN}/
    on_stop: destroy
  except:
    - master
    - develop
    - acceptance

# Deploy (TEST)
deploy-test:
  variables:
    KUBECONFIG: /secrets/kubeconfig/review.conf
    REVIEW_NAMESPACE: "hhb-test"
  extends: .deploy-app
  only:
    - develop

# Deploy (ACC)
deploy-acc:
  variables:
    KUBECONFIG: /secrets/kubeconfig/review.conf
    REVIEW_NAMESPACE: "hhb-acc"
  extends: .deploy-app
  only:
    - acceptance

# Deploy (PROD/DEMO)
deploy-proddemo:
  variables:
    KUBECONFIG: /secrets/kubeconfig/review.conf
    REVIEW_NAMESPACE: "hhb-demo"
  extends: .deploy-app
  only:
    - master

# Shut down app
destroy:
  stage: deploy
  image: registry.gitlab.com/commonground/core/review-app-deployer:latest
  variables:
    GIT_STRATEGY: none
    KUBECONFIG: /secrets/kubeconfig/review.conf
  script:
    - kubectl delete namespace $REVIEW_NAMESPACE
  when: manual
  environment:
    name: $CI_COMMIT_REF_NAME
    action: stop
  except:
    - master
    - develop
    - acceptance
  tags:
    - cg
    - docker