.cypress:
  extends: .node
  stage: e2e
  image: cypress/base:10
  variables:
    CYPRESS_CACHE_FOLDER: "$CI_PROJECT_DIR/.cache/Cypress"
  script:
    - BASE_URL=https://$(<$CI_PROJECT_DIR/ci_review_hostname.txt)
    - npx -q apollo client:download-schema --endpoint=${BASE_URL}/api/graphql schema.graphql
    - npx -q cypress run --config "baseUrl=${BASE_URL},ignoreTestFiles=**/integration/organizations.js"
  cache:
    key: "${CI_COMMIT_REF_SLUG}__${CI_JOB_NAME}"
    paths:
      - ${NPM_CACHE_DIR}
      - ${CYPRESS_CACHE_FOLDER}
  artifacts:
    when: always
    paths:
      - frontend/app/cypress/videos/*.mp4
      - frontend/app/cypress/screenshots/**/*.png
    expire_in: 1 day


cypress-review:
  extends: .cypress
  needs:
    - job: deploy-review
      artifacts: true
  except:
    - master
    - develop
    - acceptance
