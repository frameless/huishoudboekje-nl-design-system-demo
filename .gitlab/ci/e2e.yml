.cypress-token:
  stage: build
  image:
    name: ${DOCKER_PROXY}node:alpine
  tags:
    - cg
    - docker
  needs: []
  script:
    - |
      npx --yes --quiet --package '@clarketm/jwt-cli' \
        jwt sign \
        --expiresIn "1 hour" \
        --subject "cypress@huishoudboekje.nlx.reviews" \
        --issuer "https://huishoudboekje.nlx.reviews" \
        --audience "https://huishoudboekje.nlx.reviews" \
        --jwtid "$(LC_CTYPE=C tr -dc 'A-F0-9' < /dev/urandom | head -c32)" \
        --noCopy \
        "{}" "${SESSION_SECRET:-test}" > ci_cypress_token.txt
  artifacts:
    paths:
      - ci_cypress_token.txt

cypress-token-review:
  extends: .cypress-token
  environment:
    name: review/$CI_COMMIT_REF_SLUG
  except:
    - master
    - develop
    - acceptance

cypress-token-develop:
  extends: .cypress-token
  environment:
    name: test
  only:
    - develop

.cypress:
  extends: .frontend
  stage: e2e
  retry:
    max: 2
    when: script_failure
  image:
    name: ${DOCKER_PROXY}cypress/base:10
  variables:
    CYPRESS_INSTALL_BINARY: ""
    CYPRESS_CACHE_FOLDER: "$CI_PROJECT_DIR/.cache/Cypress"
  script:
    - export BASE_URL=https://$(<$CI_PROJECT_DIR/ci_review_hostname.txt)
    - export PROXY_AUTHORIZATION="Authorization:Bearer $(<$CI_PROJECT_DIR/ci_cypress_token.txt)"
    - |
      DOWN=true
      for i in $(seq 1 8); do
        if curl -sf -H "$PROXY_AUTHORIZATION" "${BASE_URL}/api/me" > /dev/null
        then
          DOWN=false
          break
        else
          sleep 6
        fi
      done
      if $DOWN; then
        exit 1
      fi
    - npm run get-schema
    - npx -q cypress run --config "baseUrl=${BASE_URL}"
  cache:
    key: "${CI_COMMIT_REF_SLUG}__${CI_JOB_NAME}"
    paths:
      - ${NPM_CACHE_DIR}
      - ${CYPRESS_CACHE_FOLDER}
  artifacts:
    when: always
    paths:
      - frontend/app/cypress/videos/*.mp4
      - frontend/app/cypress/screenshots/**/*.png
    expire_in: 1 week

cypress-review:
  extends: .cypress
  needs:
    - job: deploy-review
      artifacts: true
    - job: cypress-token-review
      artifacts: true
  except:
    - master
    - develop
    - acceptance

cypress-develop:
  extends: .cypress
  needs:
    - job: deploy-develop
      artifacts: true
    - job: cypress-token-develop
      artifacts: true
  only:
    - develop
